<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentes Orchestration System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-4">Sistema de Orquestaci√≥n de Agentes</h1>

        <!-- Agentes -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Agentes</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary mb-3" onclick="loadAgents()">Cargar Agentes</button>
                <button class="btn btn-success mb-3" onclick="showAddAgentModal()">A√±adir Agente</button>
                <div id="agents-list"></div>
            </div>
        </div>

        <!-- Nuevo Proyecto -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Nuevo Proyecto</h5>
            </div>
            <div class="card-body">
                <form id="newProjectForm">
                    <div class="mb-3">
                        <label for="projectName" class="form-label">Nombre del Proyecto</label>
                        <input type="text" class="form-control" id="projectName"
                            placeholder="Nombre descriptivo del proyecto">
                    </div>
                    <div class="mb-3">
                        <label for="projectMarkdown" class="form-label">Especificaciones del Proyecto (Markdown)</label>
                        <textarea class="form-control" id="projectMarkdown" rows="10"
                            placeholder="Escribe las especificaciones del proyecto en formato Markdown..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="projectBasePath" class="form-label">Ruta Base del Proyecto</label>
                        <input type="text" class="form-control" id="projectBasePath"
                            placeholder="Ej: C:\Users\usuario\proyectos\mi-proyecto">
                    </div>
                    <button type="button" class="btn btn-success" onclick="createNewProject()">Crear Nuevo
                        Proyecto</button>
                </form>
            </div>
        </div>

        <!-- Workflows -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Workflows</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary mb-3" onclick="loadWorkflows()">Cargar Workflows</button>
                <div id="workflows-list"></div>
            </div>
        </div>
    </div>

    <!-- Modal para a√±adir/editar agente -->
    <div class="modal fade" id="agentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="agentModalTitle">A√±adir Agente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="agentForm">
                        <div class="mb-3">
                            <label for="agentId" class="form-label">ID</label>
                            <input type="text" class="form-control" id="agentId" required>
                        </div>
                        <div class="mb-3">
                            <label for="agentDescription" class="form-label">Descripci√≥n</label>
                            <input type="text" class="form-control" id="agentDescription" required>
                        </div>
                        <div class="mb-3">
                            <label for="agentEntryPoint" class="form-label">Entry Point</label>
                            <input type="text" class="form-control" id="agentEntryPoint" required>
                        </div>
                        <div class="mb-3">
                            <label for="agentModel" class="form-label">Modelo por defecto</label>
                            <input type="text" class="form-control" id="agentModel" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveAgent()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentAgentId = null;

        async function loadAgents() {
            const response = await fetch('/api/agents');
            const data = await response.json();
            const list = document.getElementById('agents-list');
            list.innerHTML = '<ul class="list-group">';
            data.agents.forEach(agent => {
                list.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${agent.id}</strong>: ${agent.description}
                            <br><small>Modelo: ${agent.defaultModel}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="editAgent('${agent.id}')">Editar</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteAgent('${agent.id}')">Eliminar</button>
                            <button class="btn btn-sm btn-outline-success" onclick="executeAgent('${agent.id}')">Ejecutar</button>
                        </div>
                    </li>
                `;
            });
            list.innerHTML += '</ul>';
        }

        async function loadWorkflows() {
            const response = await fetch('/api/workflows');
            const data = await response.json();
            const list = document.getElementById('workflows-list');
            list.innerHTML = '<ul class="list-group">';
            data.workflows.forEach(workflow => {
                const isProject = workflow.type === 'project';
                const displayName = isProject ? `üìÅ ${workflow.artifact}` : `${workflow.from} ‚Üí ${workflow.to} (${workflow.artifact})`;
                const workflowId = isProject ? workflow.to : `${workflow.from}-${workflow.to}`;

                list.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${displayName}</strong>
                            ${isProject ? `<br><small>Proyecto creado: ${new Date(workflow.project.created_at).toLocaleString()}</small>` : ''}
                        </div>
                        <button class="btn btn-sm btn-outline-success" onclick="executeWorkflow('${workflowId}')">Ejecutar</button>
                    </li>
                `;
            });
            list.innerHTML += '</ul>';
        }

        function showAddAgentModal() {
            currentAgentId = null;
            document.getElementById('agentModalTitle').textContent = 'A√±adir Agente';
            document.getElementById('agentForm').reset();
            new bootstrap.Modal(document.getElementById('agentModal')).show();
        }

        async function editAgent(agentId) {
            const response = await fetch(`/api/agents/${agentId}`);
            const agent = await response.json();
            currentAgentId = agentId;
            document.getElementById('agentModalTitle').textContent = 'Editar Agente';
            document.getElementById('agentId').value = agent.id;
            document.getElementById('agentDescription').value = agent.description;
            document.getElementById('agentEntryPoint').value = agent.entryPoint;
            document.getElementById('agentModel').value = agent.defaultModel;
            new bootstrap.Modal(document.getElementById('agentModal')).show();
        }

        async function saveAgent() {
            const agent = {
                id: document.getElementById('agentId').value,
                description: document.getElementById('agentDescription').value,
                entryPoint: document.getElementById('agentEntryPoint').value,
                defaultModel: document.getElementById('agentModel').value,
                tools: [],
                outputs: [],
                requires: []
            };

            let response;
            if (currentAgentId) {
                response = await fetch(`/api/agents/${currentAgentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(agent)
                });
            } else {
                response = await fetch('/api/agents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(agent)
                });
            }

            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('agentModal')).hide();
                loadAgents();
            } else {
                alert('Error al guardar el agente');
            }
        }

        async function deleteAgent(agentId) {
            if (confirm('¬øEst√°s seguro de eliminar este agente?')) {
                const response = await fetch(`/api/agents/${agentId}`, { method: 'DELETE' });
                if (response.ok) {
                    loadAgents();
                } else {
                    alert('Error al eliminar el agente');
                }
            }
        }

        async function executeAgent(agentId) {
            alert(`Ejecutar agente ${agentId} - Funcionalidad pendiente de implementar`);
        }

        async function executeWorkflow(workflowId) {
            const response = await fetch(`/api/workflows/${workflowId}/execute`, { method: 'POST' });
            const result = await response.json();
            alert(result.message);
        }

        async function createNewProject() {
            const name = document.getElementById('projectName').value;
            const markdown = document.getElementById('projectMarkdown').value;
            const basePath = document.getElementById('projectBasePath').value;

            if (!markdown.trim()) {
                alert('Por favor, escribe las especificaciones del proyecto.');
                return;
            }

            const project = {
                name: name || `Proyecto ${new Date().toLocaleString()}`,
                markdown: markdown,
                base_path: basePath
            };

            const response = await fetch('/api/projects/new', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(project)
            });

            const result = await response.json();
            if (response.ok) {
                alert(result.message + ' - ID: ' + result.project_id);
                // Limpiar formulario
                document.getElementById('newProjectForm').reset();
                // Recargar workflows para mostrar el nuevo proyecto
                loadWorkflows();
            } else {
                alert('Error: ' + result.detail);
            }
        }        // Cargar datos iniciales
        loadAgents();
        loadWorkflows();
    </script>
</body>

</html>
